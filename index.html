<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á - ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢</title>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase CDN (compat) ‚Äî ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÇ‡∏Æ‡∏™‡∏ï‡πå -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyA2mvLF8xVYO_FiJDqq-7YnuAcj7ZNtU1A",
    authDomain: "tissue-express-de63f.firebaseapp.com",
    projectId: "tissue-express-de63f",
    storageBucket: "tissue-express-de63f.firebasestorage.app",
    messagingSenderId: "773208636752",
    appId: "1:773208636752:web:c6ff1467bd53199ef0c055"
  };

  window.fbReady = false;
  try {
    firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
    window.fbReady = true;
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('setup-banner').style.display = 'none';
      window.startSync();
    });
  } catch(e) { console.error('Firebase error:', e); }
</script>

<style>
:root {
  --bg:#f4f3ee;--surface:#fff;--s2:#f8f7f2;--s3:#eeecea;
  --border:#e2e0d8;--border2:#ccc9bf;
  --accent:#e85d04;--accent2:#dc2f02;
  --green:#2d9a4e;--blue:#1a6fb5;--purple:#7c3aed;--red:#b91c1c;
  --text:#1c1c18;--text2:#5a5850;--text3:#9a9890;
  --sh:0 1px 3px rgba(0,0,0,.07),0 4px 12px rgba(0,0,0,.04);
  --shd:0 4px 20px rgba(0,0,0,.13);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Sarabun',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;font-size:15px;line-height:1.55}

/* BANNER */
#setup-banner{background:linear-gradient(135deg,#fffbeb,#fef3c7);border-bottom:2px solid #f59e0b;padding:14px 20px;display:flex;gap:12px;align-items:flex-start}
.b-icon{font-size:22px;flex-shrink:0;padding-top:2px}
.b-body{flex:1}
.b-title{font-size:15px;font-weight:800;color:#78350f;margin-bottom:6px}
.b-steps{font-size:13px;color:#78350f;line-height:2}
.b-steps code{background:rgba(0,0,0,.1);padding:1px 6px;border-radius:4px;font-family:monospace;font-size:12px}
.b-close{background:none;border:none;font-size:20px;cursor:pointer;color:#78350f;flex-shrink:0}

/* NAV */
.nav{background:var(--text);height:56px;display:flex;align-items:center;padding:0 22px;gap:0;position:sticky;top:0;z-index:100}
.logo{font-size:18px;font-weight:800;color:#fff;margin-right:26px;display:flex;align-items:center;gap:8px;letter-spacing:-.3px}
.logo-dot{width:9px;height:9px;border-radius:50%;background:var(--accent)}
.tabs{display:flex;gap:3px}
.tab{padding:7px 16px;border-radius:6px;cursor:pointer;font-size:14px;font-weight:600;color:rgba(255,255,255,.5);transition:.2s;display:flex;align-items:center;gap:5px}
.tab:hover{color:rgba(255,255,255,.85);background:rgba(255,255,255,.09)}
.tab.on{background:var(--accent);color:#fff}
.sync{margin-left:auto;display:flex;align-items:center;gap:6px;font-size:12px;color:rgba(255,255,255,.4)}
.sdot{width:7px;height:7px;border-radius:50%;background:#6ee7b7}
.sdot.spin{background:#fbbf24;animation:blink .8s infinite}
.sdot.err{background:#f87171}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}

/* PAGE */
.pg{display:none}
.pg.on{display:block}
.wrap{max-width:860px;margin:0 auto;padding:26px 18px}

/* HEADER */
.ph{display:flex;align-items:center;justify-content:space-between;margin-bottom:22px;padding-bottom:14px;border-bottom:2px solid var(--border)}
.pt{font-size:21px;font-weight:800;letter-spacing:-.3px}
.dbadge{background:var(--surface);border:1.5px solid var(--border);padding:5px 14px;border-radius:20px;font-size:13px;color:var(--text2);font-weight:600;box-shadow:var(--sh)}

/* CARD */
.card{background:var(--surface);border:1.5px solid var(--border);border-radius:14px;padding:20px 22px;margin-bottom:13px;box-shadow:var(--sh)}
.ctitle{font-size:11px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:1.3px;margin-bottom:14px;display:flex;align-items:center;gap:6px}

/* GRID */
.g3{display:grid;grid-template-columns:2fr 1fr 1fr;gap:11px;align-items:end}
@media(max-width:580px){.g3{grid-template-columns:1fr 1fr}.g3 .f:first-child{grid-column:1/-1}}

/* FIELD */
.f{display:flex;flex-direction:column;gap:5px}
.f label{font-size:11px;color:var(--text2);font-weight:800;text-transform:uppercase;letter-spacing:.4px}
.f input,.f textarea{background:var(--s2);border:1.5px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-size:15px;font-family:inherit;outline:none;width:100%;transition:border-color .18s,box-shadow .18s}
.f input:focus,.f textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(232,93,4,.11);background:#fff}
.f input[type=number]{text-align:right}
.f textarea{resize:vertical;min-height:68px}
.f input::placeholder{color:var(--text3)}

/* DIVIDER */
.div{display:flex;align-items:center;gap:11px;margin:17px 0 13px}
.dlbl{font-size:11px;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:1px;white-space:nowrap}
.dline{flex:1;height:1.5px;background:var(--border)}

/* PAYMENT */
.pg-row{display:flex;gap:8px}
.pb{flex:1;padding:11px 8px;border-radius:9px;border:1.5px solid var(--border);background:var(--s2);color:var(--text2);cursor:pointer;font-size:14px;font-family:inherit;font-weight:700;text-align:center;transition:.18s;display:flex;align-items:center;justify-content:center;gap:5px}
.pb:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,93,4,.05)}
.pb.s-cash{background:#f0fdf4;border-color:var(--green);color:var(--green)}
.pb.s-qr{background:#eff6ff;border-color:var(--blue);color:var(--blue)}
.pb.s-transfer{background:#f5f3ff;border-color:var(--purple);color:var(--purple)}

/* TOTAL */
.trow{display:flex;justify-content:space-between;align-items:center;background:var(--s2);border:1.5px solid var(--border);border-radius:10px;padding:11px 18px;margin-top:14px}
.tlbl{font-size:14px;color:var(--text2);font-weight:700}
.tval{font-size:26px;font-weight:800;color:var(--accent);letter-spacing:-.5px}

/* BUTTONS */
.bsave{background:var(--accent);color:#fff;border:none;border-radius:10px;padding:14px;font-size:16px;font-weight:700;font-family:inherit;cursor:pointer;width:100%;margin-top:13px;transition:.18s;letter-spacing:.2px}
.bsave:hover{background:var(--accent2);box-shadow:0 4px 14px rgba(232,93,4,.33);transform:translateY(-1px)}
.bsave:active{transform:translateY(0)}
.bsave:disabled{background:var(--border2);cursor:not-allowed;transform:none;box-shadow:none}

/* LIST */
.lhd{display:flex;align-items:center;justify-content:space-between;margin:26px 0 11px}
.lt{font-size:17px;font-weight:800}
.lcnt{background:var(--surface);border:1.5px solid var(--border);padding:3px 12px;border-radius:20px;font-size:12px;font-weight:700;color:var(--text2)}
.ec{background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:13px 15px;margin-bottom:8px;display:flex;align-items:flex-start;justify-content:space-between;gap:11px;box-shadow:var(--sh);transition:border-color .18s}
.ec:hover{border-color:var(--border2)}
.el{flex:1;min-width:0}
.etime{font-size:11px;color:var(--text3);font-weight:700;margin-bottom:2px;letter-spacing:.3px}
.eline{font-size:14px;font-weight:500;margin-bottom:3px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.enote{font-size:13px;color:var(--text2);margin-top:3px}
.chips{display:flex;gap:5px;margin-top:6px;flex-wrap:wrap}
.chip{font-size:11px;font-weight:700;padding:2px 9px;border-radius:20px;letter-spacing:.3px;white-space:nowrap}
.cc{background:#dcfce7;color:#15803d}.cq{background:#dbeafe;color:#1d4ed8}.ct{background:#ede9fe;color:#6d28d9}
.cs{background:#fff7ed;color:#c2410c;border:1px solid #fed7aa}
.cb{background:#f0f9ff;color:#0369a1;border:1px solid #bae6fd}
.er{text-align:right;flex-shrink:0}
.eamt{font-size:20px;font-weight:800;color:var(--accent);letter-spacing:-.3px}
.ebtns{display:flex;gap:5px;margin-top:7px;justify-content:flex-end}
.bsm{padding:5px 11px;border-radius:6px;border:1.5px solid var(--border);background:var(--s2);color:var(--text2);font-size:12px;font-weight:700;font-family:inherit;cursor:pointer;transition:.18s}
.bsm:hover{border-color:var(--accent);color:var(--accent);background:rgba(232,93,4,.05)}
.bsm.del:hover{border-color:var(--red);color:var(--red);background:rgba(185,28,28,.05)}

/* EMPTY */
.empty{text-align:center;padding:42px 20px;color:var(--text3)}
.ei{font-size:36px;margin-bottom:10px}

/* DASHBOARD */
.sgrid{display:grid;grid-template-columns:repeat(3,1fr);gap:11px;margin-bottom:22px}
@media(max-width:660px){.sgrid{grid-template-columns:repeat(2,1fr)}}
.sc{background:var(--surface);border:1.5px solid var(--border);border-radius:12px;padding:15px 17px;box-shadow:var(--sh)}
.si{font-size:18px;margin-bottom:7px}
.sl{font-size:11px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:.8px;margin-bottom:2px}
.sn{font-size:22px;font-weight:800;letter-spacing:-.5px}
.ss{font-size:12px;color:var(--text2);margin-top:2px}
.co{color:var(--accent)}.cg{color:var(--green)}.cb2{color:var(--blue)}.cp{color:var(--purple)}

/* FILTER */
.fbar{display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;align-items:center}
.fbar select,.fbar input[type=date]{background:var(--surface);border:1.5px solid var(--border);border-radius:8px;padding:8px 12px;color:var(--text);font-size:14px;font-family:inherit;outline:none;cursor:pointer;box-shadow:var(--sh)}
.fbar select:focus,.fbar input[type=date]:focus{border-color:var(--accent)}
.bexp{margin-left:auto;background:var(--green);color:#fff;border:none;border-radius:8px;padding:9px 18px;font-size:14px;font-weight:700;font-family:inherit;cursor:pointer;transition:.18s;display:flex;align-items:center;gap:6px;box-shadow:var(--sh)}
.bexp:hover{opacity:.87;transform:translateY(-1px)}

/* TABLE */
.tw{background:var(--surface);border:1.5px solid var(--border);border-radius:14px;overflow:hidden;box-shadow:var(--sh);overflow-x:auto}
table{width:100%;border-collapse:collapse;min-width:680px}
thead th{background:var(--s2);padding:11px 13px;font-size:11px;font-weight:700;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;text-align:left;border-bottom:1.5px solid var(--border);white-space:nowrap}
tbody tr{border-bottom:1px solid var(--border);transition:background .12s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--s2)}
tbody td{padding:11px 13px;font-size:14px;vertical-align:middle}

/* MODAL */
.overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.48);z-index:200;justify-content:center;align-items:flex-start;padding:36px 18px;backdrop-filter:blur(3px)}
.overlay.on{display:flex}
.modal{background:var(--surface);border:1.5px solid var(--border);border-radius:16px;padding:24px;width:100%;max-width:500px;max-height:90vh;overflow-y:auto;box-shadow:var(--shd);animation:pop .22s ease}
@keyframes pop{from{transform:scale(.95) translateY(-10px);opacity:0}to{transform:scale(1);opacity:1}}
.mhd{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
.mt2{font-size:17px;font-weight:800}
.bx{background:var(--s2);border:1.5px solid var(--border);color:var(--text2);border-radius:6px;width:30px;height:30px;cursor:pointer;font-size:15px;display:flex;align-items:center;justify-content:center;transition:.18s}
.bx:hover{background:var(--red);color:#fff;border-color:var(--red)}

/* TOAST */
#toast{position:fixed;bottom:22px;right:22px;padding:11px 20px;border-radius:10px;font-size:14px;font-weight:700;z-index:300;transform:translateY(60px);opacity:0;transition:.28s;pointer-events:none;box-shadow:var(--shd);color:#fff}
#toast.on{transform:translateY(0);opacity:1}
</style>
</head>
<body>

<!-- BANNER -->
<div id="setup-banner" style="display:none"></div>

<!-- NAV -->
<nav class="nav">
  <div class="logo"><div class="logo-dot"></div>‡∏£‡πâ‡∏≤‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á</div>
  <div class="tabs">
    <div class="tab on" onclick="goPage('r')" id="tab-r">‚úèÔ∏è ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡∏≤‡∏¢</div>
    <div class="tab" onclick="goPage('d')" id="tab-d">üìä ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div>
  </div>
  <div class="sync">
    <div class="sdot" id="sdot"></div>
    <span id="stxt">‡∏£‡∏≠‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠</span>
  </div>
</nav>

<!-- ===== RECORD ===== -->
<div class="pg on" id="pg-r">
<div class="wrap">
  <div class="ph">
    <div class="pt">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢</div>
    <div class="dbadge" id="dbadge"></div>
  </div>

  <div class="card">
    <div class="ctitle">üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
      <div class="f"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</label><input id="r-sq" type="number" placeholder="0" min="0" oninput="cp()"></div>
      <div class="f"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏ä‡∏¥‡πâ‡∏ô (‡∏ø)</label><input id="r-sp" type="number" placeholder="0.00" min="0" step="0.01" oninput="cp()"></div>
    </div>
    <div class="div"><div class="dline"></div><div class="dlbl">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á</div><div class="dline"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
      <div class="f"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</label><input id="r-bq" type="number" placeholder="0" min="0" oninput="cp()"></div>
      <div class="f"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏ä‡∏¥‡πâ‡∏ô (‡∏ø)</label><input id="r-bp" type="number" placeholder="0.00" min="0" step="0.01" oninput="cp()"></div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">üßª ‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
      <div class="f"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏ä‡∏¥‡πâ‡∏ô)</label><input id="r-oq" type="number" placeholder="0" min="0" oninput="cp()"></div>
      <div class="f"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏ä‡∏¥‡πâ‡∏ô (‡∏ø)</label><input id="r-op" type="number" placeholder="0.00" min="0" step="0.01" oninput="cp()"></div>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</div>
    <div class="pg-row">
      <button class="pb" id="p-cash" onclick="sp('cash')">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      <button class="pb" id="p-qr" onclick="sp('qr')">üì± QR Code</button>
      <button class="pb" id="p-transfer" onclick="sp('transfer')">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÑ‡∏•‡∏ô‡πå)</button>
    </div>
  </div>

  <div class="card">
    <div class="ctitle">üìù ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</div>
    <div class="f"><textarea id="r-note" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤, ‡πÄ‡∏•‡∏Ç‡∏û‡∏±‡∏™‡∏î‡∏∏, ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏..."></textarea></div>
    <div class="trow"><span class="tlbl">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="tval" id="r-tot">‡∏ø 0.00</span></div>
    <button class="bsave" id="bsave" onclick="saveE()">‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
  </div>

  <div class="lhd"><div class="lt">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div><div class="lcnt" id="tcnt">0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
  <div id="tlist"></div>
</div>
</div>

<!-- ===== DASHBOARD ===== -->
<div class="pg" id="pg-d">
<div class="wrap">
  <div class="ph"><div class="pt">‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î</div></div>
  <div class="sgrid" id="sgrid"></div>
  <div class="fbar">
    <select id="fp" onchange="rd()">
      <option value="today">‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</option>
      <option value="week">7 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</option>
      <option value="month" selected>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</option>
      <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
    </select>
    <input type="date" id="ff" onchange="rd()">
    <input type="date" id="ft" onchange="rd()">
    <select id="fpay" onchange="rd()">
      <option value="">‡∏ó‡∏∏‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á</option>
      <option value="cash">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
      <option value="qr">QR Code</option>
      <option value="transfer">‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</option>
    </select>
    <button class="bexp" onclick="exportX()">üì• Export Excel</button>
  </div>
  <div class="tw">
    <table>
      <thead><tr>
        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà/‡πÄ‡∏ß‡∏•‡∏≤</th><th>‡∏Ç‡∏ô‡∏™‡πà‡∏á (‡∏à‡∏ô.√ó‡∏£‡∏≤‡∏Ñ‡∏≤)</th>
        <th>‡∏Å‡∏•‡πà‡∏≠‡∏á (‡∏à‡∏ô.√ó‡∏£‡∏≤‡∏Ñ‡∏≤)</th><th>‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà</th><th>‡∏ä‡∏≥‡∏£‡∏∞</th><th>‡∏£‡∏ß‡∏°</th><th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th><th></th>
      </tr></thead>
      <tbody id="dtb"></tbody>
    </table>
    <div id="demp" class="empty" style="display:none"><div class="ei">üì≠</div><div>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
  </div>
</div>
</div>

<!-- EDIT MODAL -->
<div class="overlay" id="modal">
<div class="modal">
  <div class="mhd"><div class="mt2">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div><button class="bx" onclick="cModal()">‚úï</button></div>
  <div class="card" style="margin-bottom:11px">
    <div class="ctitle">üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
      <div class="f"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input id="e-sq" type="number" min="0" oninput="ce()"></div>
      <div class="f"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏ä‡∏¥‡πâ‡∏ô</label><input id="e-sp" type="number" min="0" step="0.01" oninput="ce()"></div>
    </div>
    <div class="div"><div class="dline"></div><div class="dlbl">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á</div><div class="dline"></div></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
      <div class="f"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input id="e-bq" type="number" min="0" oninput="ce()"></div>
      <div class="f"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏ä‡∏¥‡πâ‡∏ô</label><input id="e-bp" type="number" min="0" step="0.01" oninput="ce()"></div>
    </div>
  </div>
  <div class="card" style="margin-bottom:11px">
    <div class="ctitle">üßª ‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:11px">
      <div class="f"><label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</label><input id="e-oq" type="number" min="0" oninput="ce()"></div>
      <div class="f"><label>‡∏£‡∏≤‡∏Ñ‡∏≤ / ‡∏ä‡∏¥‡πâ‡∏ô</label><input id="e-op" type="number" min="0" step="0.01" oninput="ce()"></div>
    </div>
  </div>
  <div class="card" style="margin-bottom:11px">
    <div class="ctitle">üí≥ ‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</div>
    <div class="pg-row">
      <button class="pb" id="ep-cash" onclick="sep('cash')">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      <button class="pb" id="ep-qr" onclick="sep('qr')">üì± QR Code</button>
      <button class="pb" id="ep-transfer" onclick="sep('transfer')">üè¶ ‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÑ‡∏•‡∏ô‡πå)</button>
    </div>
  </div>
  <div class="card">
    <div class="f"><label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><textarea id="e-note"></textarea></div>
    <div class="trow"><span class="tlbl">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</span><span class="tval" id="e-tot">‡∏ø 0.00</span></div>
    <button class="bsave" onclick="saveEd()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
  </div>
</div>
</div>

<div id="toast"></div>

<script>
let entries=[], selPay='', editPay='', editId=null;
const PL={cash:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',qr:'QR Code',transfer:'‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÑ‡∏•‡∏ô‡πå)'};
const PE={cash:'üíµ',qr:'üì±',transfer:'üè¶'};
const PC={cash:'cc',qr:'cq',transfer:'ct'};

document.addEventListener('DOMContentLoaded',()=>{
  upDate();
  setInterval(upDate,60000);
  setTimeout(()=>{
    if(!window.fbReady){loadL();setSS('err','‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå');}
  },3000);
});

window.startSync=function(){
  setSS('spin','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
  window.db.collection('sales').orderBy('timestamp','desc')
    .onSnapshot(snap=>{
      entries=snap.docs.map(d=>({id:d.id,...d.data()}));
      saveL(); rtl(); rd(); setSS('','‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡πâ‡∏ß');
    },err=>{setSS('err','‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß');loadL();});
};

function loadL(){try{const r=localStorage.getItem('ts2');if(r)entries=JSON.parse(r);}catch(e){}rtl();rd();}
function saveL(){localStorage.setItem('ts2',JSON.stringify(entries));}
function setSS(s,t){
  const d=document.getElementById('sdot');
  d.className='sdot'+(s?(' '+s):'');
  document.getElementById('stxt').textContent=t;
}
function upDate(){document.getElementById('dbadge').textContent=new Date().toLocaleDateString('th-TH',{weekday:'short',day:'numeric',month:'long',year:'numeric'});}

// PAGE
function goPage(p){
  ['r','d'].forEach(n=>{
    document.getElementById('pg-'+n).classList.toggle('on',n===p);
    document.getElementById('tab-'+n).classList.toggle('on',n===p);
  });
  if(p==='d')rd();
}

// PAYMENT
function sp(t){selPay=t;['cash','qr','transfer'].forEach(x=>document.getElementById('p-'+x).className='pb'+(x===t?' s-'+x:''));}
function sep(t){editPay=t;['cash','qr','transfer'].forEach(x=>document.getElementById('ep-'+x).className='pb'+(x===t?' s-'+x:''));}

// CALC
function gv(p){const q=parseFloat(document.getElementById(p+'-sq').value)||0,pr=parseFloat(document.getElementById(p+'-sp').value)||0;return{q,pr,s:q*pr};}
function gvb(p){const q=parseFloat(document.getElementById(p+'-bq').value)||0,pr=parseFloat(document.getElementById(p+'-bp').value)||0;return{q,pr,s:q*pr};}
function gvo(p){const q=parseFloat(document.getElementById(p+'-oq').value)||0,pr=parseFloat(document.getElementById(p+'-op').value)||0;return{q,pr,s:q*pr};}
function cp(){const t=gv('r').s+gvb('r').s+gvo('r').s;document.getElementById('r-tot').textContent='‡∏ø '+fmt(t);return t;}
function ce(){const t=gv('e').s+gvb('e').s+gvo('e').s;document.getElementById('e-tot').textContent='‡∏ø '+fmt(t);return t;}
function fmt(n){return n.toLocaleString('th-TH',{minimumFractionDigits:2,maximumFractionDigits:2});}

// SAVE
async function saveE(){
  const total=cp();
  if(total<=0){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏Ñ‡∏≤','#e85d04');return;}
  if(!selPay){toast('‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô','#e85d04');return;}
  const sv=gv('r'),bv=gvb('r'),ov=gvo('r');
  const data={
    shipQty:sv.q,shipPrice:sv.pr,shipSub:sv.s,
    boxQty:bv.q,boxPrice:bv.pr,boxSub:bv.s,
    otherName:'‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà',otherQty:ov.q,otherPrice:ov.pr,otherSub:ov.s,
    payment:selPay,note:document.getElementById('r-note').value.trim(),total
  };
  const btn=document.getElementById('bsave');
  btn.disabled=true;btn.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';
  if(window.fbReady){
    try{
      await window.db.collection('sales').add({...data, timestamp: firebase.firestore.FieldValue.serverTimestamp()});
    }catch(e){toast('‚ùå '+e.message,'#b91c1c');btn.disabled=false;btn.textContent='‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';return;}
  }else{
    data.id=Date.now().toString();data.timestamp=new Date().toISOString();
    entries.unshift(data);saveL();rtl();rd();
  }
  clearF();btn.disabled=false;btn.textContent='‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  toast('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}
function clearF(){
  ['r-sq','r-sp','r-bq','r-bp','r-oq','r-op','r-note'].forEach(id=>document.getElementById(id).value='');
  selPay='';['cash','qr','transfer'].forEach(x=>document.getElementById('p-'+x).className='pb');
  document.getElementById('r-tot').textContent='‡∏ø 0.00';
}

// DELETE
async function delE(id){
  if(!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?'))return;
  if(window.fbReady){
    try{await window.db.collection('sales').doc(id).delete();}
    catch(e){toast('‚ùå ‡∏•‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','#b91c1c');return;}
  }else{entries=entries.filter(e=>e.id!==id);saveL();rtl();rd();}
  toast('üóëÔ∏è ‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß','#b91c1c');
}

// EDIT
function openEd(id){
  const e=entries.find(x=>x.id===id);if(!e)return;
  editId=id;
  document.getElementById('e-sq').value=e.shipQty||0;
  document.getElementById('e-sp').value=e.shipPrice||0;
  document.getElementById('e-bq').value=e.boxQty||0;
  document.getElementById('e-bp').value=e.boxPrice||0;
  document.getElementById('e-oq').value=e.otherQty||0;
  document.getElementById('e-op').value=e.otherPrice||0;
  document.getElementById('e-note').value=e.note||'';
  sep(e.payment||'');ce();
  document.getElementById('modal').classList.add('on');
}
function cModal(){document.getElementById('modal').classList.remove('on');editId=null;}
document.getElementById('modal').addEventListener('click',e=>{if(e.target.id==='modal')cModal();});
async function saveEd(){
  const sv=gv('e'),bv=gvb('e'),ov=gvo('e');
  const u={
    shipQty:sv.q,shipPrice:sv.pr,shipSub:sv.s,
    boxQty:bv.q,boxPrice:bv.pr,boxSub:bv.s,
    otherName:'‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà',otherQty:ov.q,otherPrice:ov.pr,otherSub:ov.s,
    payment:editPay,note:document.getElementById('e-note').value.trim(),total:sv.s+bv.s+ov.s
  };
  if(window.fbReady){
    try{await window.db.collection('sales').doc(editId).update(u);}
    catch(e){toast('‚ùå ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß','#b91c1c');return;}
  }else{
    const i=entries.findIndex(x=>x.id===editId);
    if(i!==-1)entries[i]={...entries[i],...u};saveL();rtl();rd();
  }
  cModal();toast('‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// TODAY LIST
function rtl(){
  const today=new Date().toDateString();
  const list=entries.filter(e=>{
    const ts=e.timestamp;if(!ts)return false;
    return(ts.toDate?ts.toDate():new Date(ts)).toDateString()===today;
  });
  document.getElementById('tcnt').textContent=list.length+' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  const el=document.getElementById('tlist');
  if(!list.length){el.innerHTML='<div class="empty"><div class="ei">üìù</div><div>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div></div>';return;}
  el.innerHTML=list.map(eCard).join('');
}
function eCard(e){
  const ts=e.timestamp;const d=ts?.toDate?ts.toDate():new Date(ts||Date.now());
  const t=d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
  const lines=[];
  if(e.shipQty>0)lines.push('‡∏Ç‡∏ô‡∏™‡πà‡∏á √ó '+e.shipQty+' (‡∏ø'+e.shipPrice+')');
  if(e.boxQty>0)lines.push('‡∏Å‡∏•‡πà‡∏≠‡∏á √ó '+e.boxQty+' (‡∏ø'+e.boxPrice+')');
  if(e.otherName&&e.otherQty>0)lines.push(e.otherName+' √ó '+e.otherQty+' (‡∏ø'+e.otherPrice+')');
  return`<div class="ec">
    <div class="el">
      <div class="etime">${t}</div>
      <div class="eline">${lines.join('  ‚Ä¢  ')||'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢'}</div>
      ${e.note?`<div class="enote">${e.note}</div>`:''}
      <div class="chips">
        <span class="chip ${PC[e.payment]||''}">${PE[e.payment]||''} ${PL[e.payment]||e.payment}</span>
        ${e.shipQty>0?`<span class="chip cs">üöö ‡∏Ç‡∏ô‡∏™‡πà‡∏á ${e.shipQty} ‡∏ä‡∏¥‡πâ‡∏ô</span>`:''}
        ${e.boxQty>0?`<span class="chip cb">üì¶ ‡∏Å‡∏•‡πà‡∏≠‡∏á ${e.boxQty} ‡∏ä‡∏¥‡πâ‡∏ô</span>`:''}
        ${e.otherName&&e.otherQty>0?`<span class="chip" style="background:#f0fdf4;color:#166534;border:1px solid #bbf7d0">üõçÔ∏è ${e.otherName} ${e.otherQty} ‡∏ä‡∏¥‡πâ‡∏ô</span>`:''}      </div>
    </div>
    <div class="er">
      <div class="eamt">‡∏ø${fmt(e.total||0)}</div>
      <div class="ebtns">
        <button class="bsm" onclick="openEd('${e.id}')">‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
        <button class="bsm del" onclick="delE('${e.id}')">üóëÔ∏è</button>
      </div>
    </div>
  </div>`;
}

// DASHBOARD
function fData(){
  const per=document.getElementById('fp').value,payF=document.getElementById('fpay').value;
  const from=document.getElementById('ff').value,to=document.getElementById('ft').value;
  const now=new Date();
  return entries.filter(e=>{
    const ts=e.timestamp;if(!ts)return false;
    const d=ts.toDate?ts.toDate():new Date(ts);
    const ds=d.toISOString().slice(0,10);
    if(from||to){if(from&&ds<from)return false;if(to&&ds>to)return false;}
    else if(per==='today'){if(d.toDateString()!==now.toDateString())return false;}
    else if(per==='week'){if(d<new Date(now-7*86400000))return false;}
    else if(per==='month'){if(d.getMonth()!==now.getMonth()||d.getFullYear()!==now.getFullYear())return false;}
    if(payF&&e.payment!==payF)return false;
    return true;
  });
}
function rd(){
  const data=fData();
  const sm=(f)=>data.filter(f).reduce((s,e)=>s+(e.total||0),0);
  const cn=(f)=>data.filter(f).length;
  const shipTotal=data.reduce((s,e)=>s+(e.shipSub||0),0);
  const boxTotal=data.reduce((s,e)=>s+(e.boxSub||0),0);
  const otherTotal=data.reduce((s,e)=>s+(e.otherSub||0),0);
  const shipCnt=data.filter(e=>e.shipQty>0).reduce((s,e)=>s+(e.shipQty||0),0);
  const boxCnt=data.filter(e=>e.boxQty>0).reduce((s,e)=>s+(e.boxQty||0),0);
  const otherCnt=data.filter(e=>e.otherQty>0).reduce((s,e)=>s+(e.otherQty||0),0);
  const qrTransferTotal = sm(e=>e.payment==='qr'||e.payment==='transfer');
  const qrTransferCnt   = cn(e=>e.payment==='qr'||e.payment==='transfer');
  const n=v=>v.toLocaleString('th-TH',{maximumFractionDigits:0});
  document.getElementById('sgrid').innerHTML=`
    <div class="sc"><div class="si">üí∞</div><div class="sl">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div><div class="sn co">‡∏ø${n(sm(()=>1))}</div><div class="ss">${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
    <div class="sc"><div class="si">üöö</div><div class="sl">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Ç‡∏ô‡∏™‡πà‡∏á</div><div class="sn" style="color:#c2410c">‡∏ø${n(shipTotal)}</div><div class="ss">${shipCnt} ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
    <div class="sc"><div class="si">üì¶</div><div class="sl">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏Å‡∏•‡πà‡∏≠‡∏á</div><div class="sn" style="color:#0369a1">‡∏ø${n(boxTotal)}</div><div class="ss">${boxCnt} ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
    <div class="sc"><div class="si">üßª</div><div class="sl">‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà</div><div class="sn" style="color:#166534">‡∏ø${n(otherTotal)}</div><div class="ss">${otherCnt} ‡∏ä‡∏¥‡πâ‡∏ô</div></div>
    <div class="sc"><div class="si">üíµ</div><div class="sl">‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</div><div class="sn cg">‡∏ø${n(sm(e=>e.payment==='cash'))}</div><div class="ss">${cn(e=>e.payment==='cash')} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>
    <div class="sc"><div class="si">üì±üè¶</div><div class="sl">QR / ‡πÇ‡∏≠‡∏ô (‡πÑ‡∏•‡∏ô‡πå)</div><div class="sn cb2">‡∏ø${n(qrTransferTotal)}</div><div class="ss">${qrTransferCnt} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div></div>`;
  const tb=document.getElementById('dtb');
  const pc={cash:'cg',qr:'cb2',transfer:'cp'};
  if(!data.length){tb.innerHTML='';document.getElementById('demp').style.display='block';return;}
  document.getElementById('demp').style.display='none';
  tb.innerHTML=data.map(e=>{
    const d=e.timestamp?.toDate?e.timestamp.toDate():new Date(e.timestamp||Date.now());
    const ds=d.toLocaleDateString('th-TH',{day:'2-digit',month:'short',year:'2-digit'});
    const ts=d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'});
    return`<tr>
      <td style="color:var(--text2);font-size:13px;white-space:nowrap">${ds}<br>${ts}</td>
      <td>${e.shipQty>0?`${e.shipQty} √ó ‡∏ø${e.shipPrice}`:'-'}</td>
      <td>${e.boxQty>0?`${e.boxQty} √ó ‡∏ø${e.boxPrice}`:'-'}</td>
      <td>${e.otherName&&e.otherQty>0?`${e.otherName} ${e.otherQty}√ó‡∏ø${e.otherPrice}`:'-'}</td>
      <td class="${pc[e.payment]||''}" style="font-weight:700;font-size:13px">${PE[e.payment]||''} ${PL[e.payment]||e.payment}</td>
      <td style="font-weight:800;color:var(--accent)">‡∏ø${fmt(e.total||0)}</td>
      <td style="color:var(--text2);font-size:13px;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${e.note||'-'}</td>
      <td><div style="display:flex;gap:4px">
        <button class="bsm" onclick="openEd('${e.id}')">‚úèÔ∏è</button>
        <button class="bsm del" onclick="delE('${e.id}')">üóëÔ∏è</button>
      </div></td>
    </tr>`;
  }).join('');
}

// EXPORT
function exportX(){
  const data=fData();
  if(!data.length){toast('‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•','#e85d04');return;}
  const rows=data.map(e=>{
    const d=e.timestamp?.toDate?e.timestamp.toDate():new Date(e.timestamp||Date.now());
    return{'‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà':d.toLocaleDateString('th-TH'),'‡πÄ‡∏ß‡∏•‡∏≤':d.toLocaleTimeString('th-TH',{hour:'2-digit',minute:'2-digit'}),
      '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡∏ô‡∏™‡πà‡∏á':e.shipQty||0,'‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏¥‡πâ‡∏ô(‡∏Ç‡∏ô‡∏™‡πà‡∏á)':e.shipPrice||0,'‡∏£‡∏ß‡∏°‡∏Ç‡∏ô‡∏™‡πà‡∏á':e.shipSub||0,
      '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏•‡πà‡∏≠‡∏á':e.boxQty||0,'‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏¥‡πâ‡∏ô(‡∏Å‡∏•‡πà‡∏≠‡∏á)':e.boxPrice||0,'‡∏£‡∏ß‡∏°‡∏Å‡∏•‡πà‡∏≠‡∏á':e.boxSub||0,
      '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà':e.otherQty||0,'‡∏£‡∏≤‡∏Ñ‡∏≤/‡∏ä‡∏¥‡πâ‡∏ô(‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà)':e.otherPrice||0,'‡∏£‡∏ß‡∏°‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà':e.otherSub||0,
      '‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞':PL[e.payment]||e.payment,'‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°':e.total||0,'‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏':e.note||''};
  });
  const ws=XLSX.utils.json_to_sheet(rows);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢');
  const total=data.reduce((s,e)=>s+(e.total||0),0);
  const ws2=XLSX.utils.aoa_to_sheet([['‡∏™‡∏£‡∏∏‡∏õ',''],['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£',data.length],['‡∏£‡∏ß‡∏°',total],
    ['‡∏Ç‡∏ô‡∏™‡πà‡∏á',data.reduce((s,e)=>s+(e.shipSub||0),0)],
    ['‡∏Å‡∏•‡πà‡∏≠‡∏á',data.reduce((s,e)=>s+(e.boxSub||0),0)],
    ['‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà',data.reduce((s,e)=>s+(e.otherSub||0),0)],
    ['‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',data.filter(e=>e.payment==='cash').reduce((s,e)=>s+(e.total||0),0)],
    ['QR Code',data.filter(e=>e.payment==='qr').reduce((s,e)=>s+(e.total||0),0)],
    ['‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡πÑ‡∏•‡∏ô‡πå)',data.filter(e=>e.payment==='transfer').reduce((s,e)=>s+(e.total||0),0)]]);
  XLSX.utils.book_append_sheet(wb,ws2,'‡∏™‡∏£‡∏∏‡∏õ');
  const n=new Date();
  XLSX.writeFile(wb,`‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢_${n.getFullYear()}${String(n.getMonth()+1).padStart(2,'0')}${String(n.getDate()).padStart(2,'0')}.xlsx`);
  toast('üì• Export ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
}

// TOAST
function toast(msg,color='#2d9a4e'){
  const el=document.getElementById('toast');el.style.background=color;
  el.textContent=msg;el.classList.add('on');
  setTimeout(()=>el.classList.remove('on'),2800);
}
</script>
</body>
</html>
